name: Generate Snake and Pacman Animations

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Generate Snake Animations
      - name: Generate GitHub Contributions Snake Animations
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/snake/github-snake.svg
            dist/snake/github-snake-dark.svg?palette=github-dark
            dist/snake/github-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9

      # Step 3: Generate Pacman Animation (SVG only)
      - name: Generate Pacman Contribution Animation
        uses: abozanona/pacman-contribution-graph@main
        with:
          github_user_name: ${{ github.repository_owner }}
          dark_mode: true
          
      # Step 4: Install FFmpeg and create Pacman GIF
      - name: Install FFmpeg and Create Pacman GIF
        run: |
          # Install FFmpeg
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          # Create pacman directory
          mkdir -p dist/pacman
          
          # Check if pacman files exist
          if [ -f "dist/pacman-contribution-graph.svg" ]; then
            echo "✅ Found Pacman light SVG"
            cp dist/pacman-contribution-graph.svg dist/pacman/pacman.svg
            
            # Convert SVG to GIF using FFmpeg
            ffmpeg -i dist/pacman-contribution-graph.svg -vf "fps=10,scale=800:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" -loop 0 dist/pacman/pacman.gif
            echo "✅ Created Pacman GIF from light SVG"
          fi
          
          if [ -f "dist/pacman-contribution-graph-dark.svg" ]; then
            echo "✅ Found Pacman dark SVG"
            cp dist/pacman-contribution-graph-dark.svg dist/pacman/pacman-dark.svg
            
            # Convert dark SVG to GIF
            ffmpeg -i dist/pacman-contribution-graph-dark.svg -vf "fps=10,scale=800:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" -loop 0 dist/pacman/pacman-dark.gif
            echo "✅ Created Pacman dark GIF"
          fi
          
          echo "Files in dist/pacman:"
          ls -la dist/pacman/

      # Step 5: Check for generated files
      - name: Check for generated files
        id: check_files
        run: |
          if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
            echo "✅ Files generated successfully"
            echo "files_exist=true" >> $GITHUB_OUTPUT
            echo "Generated files:"
            find dist -type f -name "*.svg" -o -name "*.gif" | head -20
          else
            echo "⚠️ Warning: No animation files were generated."
            echo "files_exist=false" >> $GITHUB_OUTPUT
          fi

      # Step 6: Deploy all generated files
      - name: Deploy to Output Branch
        if: steps.check_files.outputs.files_exist == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.SNAKE_ACCESS_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          commit_message: "Update snake and pacman animations [skip ci]"
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          keep_files: true
