name: Generate Animations

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.SNAKE_ACCESS_TOKEN }}
          
      # Generate PACMAN animation
      - name: Generate Pacman animation
        uses: abozanona/pacman-contribution-graph@main
        with:
          github_user_name: bojanavasilevska
          
      # Generate SNAKE animation
      - name: Generate Snake animation
        uses: Platane/snk@v3
        with:
          github_user_name: bojanavasilevska
          outputs: |
            dist/snake.svg?palette=github-light
            dist/snake-dark.svg?palette=github-dark
          
      # Create combined directory structure
      - name: Prepare files for output branch
        run: |
          mkdir -p output/pacman output/snake
          
          # Copy Pacman files
          cp dist/pacman-contribution-graph.svg output/pacman/ 2>/dev/null || true
          cp dist/pacman-contribution-graph-dark.svg output/pacman/ 2>/dev/null || true
          
          # Copy Snake files
          cp dist/snake.svg output/snake/ 2>/dev/null || true
          cp dist/snake-dark.svg output/snake/ 2>/dev/null || true
          
          # Also keep copies in root dist for backward compatibility
          mkdir -p dist-final
          cp output/pacman/* dist-final/ 2>/dev/null || true
          cp output/snake/* dist-final/ 2>/dev/null || true
          
      # Deploy to output branch
      - name: Deploy to output branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.SNAKE_ACCESS_TOKEN }}
          publish_branch: output
          publish_dir: ./output
          keep_files: true
          user_name: 'github-actions'
          user_email: 'github-actions@github.com'
          commit_message: 'Update animations - ${{ github.event.head_commit.message }}'
          
      # Also deploy root files if needed
      - name: Deploy root files to output branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.SNAKE_ACCESS_TOKEN }}
          publish_branch: output
          publish_dir: ./dist-final
          destination_dir: ./root
          keep_files: true
          user_name: 'github-actions'
          user_email: 'github-actions@github.com'
